---
apiVersion: cortex.cloud/v1alpha1
kind: Pipeline
metadata:
  name: vmware-general-purpose-load-balancing
spec:
  schedulingDomain: nova
  description: |
    Nova provides virtual machine placement on compute hosts for OpenStack.
    After applying its own filtering and weighing logic, it delegates to cortex
    for additional filtering and weighing via this external scheduler pipeline.
    Cortex returns a ranked list of hosts back to nova for final selection.
    This is the pipeline used for VMware.

    Specifically, this pipeline is used for general purpose workloads.
  type: filter-weigher
  createDecisions: false
  filters: []
  weighers:
    - name: vmware_general_purpose_balancing
      description: |
        This step balances non-HANA VMs across non-HANA exclusive VMware hosts. It
        pulls vms onto the freeest hosts possible to ensure an even distribution of
        workloads across the available infrastructure.
      params:
        - {key: ramUtilizedLowerBoundPct, floatValue: 0}
        - {key: ramUtilizedUpperBoundPct, floatValue: 100}
        - {key: ramUtilizedActivationLowerBound, floatValue: 1.0}
        - {key: ramUtilizedActivationUpperBound, floatValue: 0.0}
    - name: vmware_avoid_long_term_contended_hosts
      description: |
        This step avoids placing vms on vmware hosts with a high CPU contention over
        a longer period of time, based on vrops contention metrics. In particular,
        this step looks at a longer time window of 4 weeks to identify hosts that
        are consistently contended.
      params:
        - {key: avgCPUContentionLowerBound, floatValue: 0} # pct
        - {key: avgCPUContentionUpperBound, floatValue: 10} # pct
        - {key: avgCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: avgCPUContentionActivationUpperBound, floatValue: -0.75}
        - {key: maxCPUContentionLowerBound, floatValue: 0} # pct
        - {key: maxCPUContentionUpperBound, floatValue: 10} # pct
        - {key: maxCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: maxCPUContentionActivationUpperBound, floatValue: -0.25}
    - name: vmware_avoid_short_term_contended_hosts
      description: |
        This step avoids placing vms on vmware hosts with a high CPU contention over
        a shorter period of time, based on vrops contention metrics. In particular,
        this step looks at a shorter time window of 20 minutes to identify hosts that
        are currently contended.
      params:
        - {key: avgCPUContentionLowerBound, floatValue: 0} # pct
        - {key: avgCPUContentionUpperBound, floatValue: 10} # pct
        - {key: avgCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: avgCPUContentionActivationUpperBound, floatValue: -0.75}
        - {key: maxCPUContentionLowerBound, floatValue: 0} # pct
        - {key: maxCPUContentionUpperBound, floatValue: 10} # pct
        - {key: maxCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: maxCPUContentionActivationUpperBound, floatValue: -0.25}
---
apiVersion: cortex.cloud/v1alpha1
kind: Pipeline
metadata:
  name: vmware-hana-bin-packing
spec:
  schedulingDomain: nova
  description: |
    Nova provides virtual machine placement on compute hosts for OpenStack.
    After applying its own filtering and weighing logic, it delegates to cortex
    for additional filtering and weighing via this external scheduler pipeline.
    Cortex returns a ranked list of hosts back to nova for final selection.
    This is the pipeline used for VMware.

    Specifically, this pipeline is used for HANA workloads.
  type: filter-weigher
  createDecisions: false
  filters: []
  weighers:
    - name: vmware_hana_binpacking
      description: |
        This step pulls HANA VMs onto the smallest possible gaps on HANA-exclusive
        VMware hosts. In this way hosts with much free space are held free for
        larger HANA VMs, improving overall packing efficiency for HANA workloads.
      params:
        - {key: ramUtilizedAfterLowerBoundPct, floatValue: 0}
        - {key: ramUtilizedAfterUpperBoundPct, floatValue: 100}
        - {key: ramUtilizedAfterActivationLowerBound, floatValue: 0.0}
        - {key: ramUtilizedAfterActivationUpperBound, floatValue: 1.0}
    - name: vmware_avoid_long_term_contended_hosts
      description: |
        This step avoids placing vms on vmware hosts with a high CPU contention over
        a longer period of time, based on vrops contention metrics. In particular,
        this step looks at a longer time window of 4 weeks to identify hosts that
        are consistently contended.
      params:
        - {key: avgCPUContentionLowerBound, floatValue: 0} # pct
        - {key: avgCPUContentionUpperBound, floatValue: 10} # pct
        - {key: avgCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: avgCPUContentionActivationUpperBound, floatValue: -0.75}
        - {key: maxCPUContentionLowerBound, floatValue: 0} # pct
        - {key: maxCPUContentionUpperBound, floatValue: 10} # pct
        - {key: maxCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: maxCPUContentionActivationUpperBound, floatValue: -0.25}
    - name: vmware_avoid_short_term_contended_hosts
      description: |
        This step avoids placing vms on vmware hosts with a high CPU contention over
        a shorter period of time, based on vrops contention metrics. In particular,
        this step looks at a shorter time window of 20 minutes to identify hosts that
        are currently contended.
      params:
        - {key: avgCPUContentionLowerBound, floatValue: 0} # pct
        - {key: avgCPUContentionUpperBound, floatValue: 10} # pct
        - {key: avgCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: avgCPUContentionActivationUpperBound, floatValue: -0.75}
        - {key: maxCPUContentionLowerBound, floatValue: 0} # pct
        - {key: maxCPUContentionUpperBound, floatValue: 10} # pct
        - {key: maxCPUContentionActivationLowerBound, floatValue: 0.0}
        - {key: maxCPUContentionActivationUpperBound, floatValue: -0.25}