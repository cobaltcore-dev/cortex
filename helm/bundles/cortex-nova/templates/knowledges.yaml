---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: vmware-resolved-hostsystems
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: vrops_hostsystem_resolver
  description: |
    Resolves the hostsystem label provided to the vrops prometheus metrics to
    the associated nova hypervisor compute host.
  recency: "1h"
  dependencies:
    datasources:
      - name: nova-hypervisors
      - name: nova-servers
      - name: nova-deleted-servers
      # Any vrops vm metric suffices here.
      - name: vrops-virtualmachine-cpu-demand-ratio
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: vmware-project-noisiness
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: vrops_project_noisiness_extractor
  description: |
    Calculates how noisy projects are in terms of CPU contention on their VMs'
    hostsystems.
  recency: "6h"
  dependencies:
    datasources:
      - name: nova-hypervisors
      - name: nova-servers
      - name: vrops-virtualmachine-cpu-demand-ratio
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: vmware-long-term-contended-hosts
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: vrops_hostsystem_contention_long_term_extractor
  description: |
    Identifies hostsystems that have been contended for long periods of time.
  dependencies:
    knowledges:
      - name: vmware-resolved-hostsystems
    datasources:
      - name: vrops-hostsystem-cpu-contention-long-term-percentage
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: vmware-short-term-contended-hosts
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: vrops_hostsystem_contention_short_term_extractor
  description: |
    Identifies hostsystems that have been contended for short periods of time.
  dependencies:
    knowledges:
      - name: vmware-resolved-hostsystems
    datasources:
      - name: vrops-hostsystem-cpu-contention-short-term-percentage
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: kvm-libvirt-domain-cpu-steal-pct
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: kvm_libvirt_domain_cpu_steal_pct_extractor
  description: |
    Identifies KVM libvirt domains that are experiencing CPU steal.
  dependencies:
    datasources:
      - name: kvm-libvirt-domain-steal-pct
      - name: nova-servers
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: host-pinned-projects
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: host_pinned_projects_extractor
  description: |
    Extract host-to-project pinning relationships from Nova aggregates.
  recency: "5m"
  dependencies:
    datasources:
      - name: nova-aggregates
      - name: nova-hypervisors
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: host-utilization
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: host_utilization_extractor
  description: |
    Extract how much space is available on each host.
  recency: "60s"
  dependencies:
    datasources:
      - name: nova-hypervisors
      - name: placement-resource-provider-inventory-usages
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: host-capabilities
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: host_capabilities_extractor
  description: |
    Extract capabilities of each host.
  recency: "60s"
  dependencies:
    datasources:
      - name: nova-hypervisors
      - name: placement-resource-provider-traits
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: vm-host-residency
spec:
  operator: cortex-nova
  # TODO: This feature is currently too large to fit in the CR status.
  storeInDatabaseOnly: true
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: vm_host_residency_extractor
  description: |
    Extract VM residency information.
  recency: "60s"
  dependencies:
    datasources:
      - name: nova-flavors
      - name: nova-servers
      - name: nova-migrations
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: vm-life-span
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: vm_life_span_histogram_extractor
  description: |
    Extract VM life span information.
  recency: "60s"
  dependencies:
    datasources:
      - name: nova-flavors
      - name: nova-deleted-servers
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: host-az
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: host_az_extractor
  description: |
    Extract host availability zone information.
  recency: "60s"
  dependencies:
    datasources:
      - name: nova-hypervisors
      - name: nova-aggregates
---
apiVersion: knowledge.cortex/v1alpha1
kind: Knowledge
metadata:
  name: sap-host-details
spec:
  operator: cortex-nova
  databaseSecretRef:
    name: cortex-nova-postgres
    namespace: {{ .Release.Namespace }}
  extractor:
    name: sap_host_details_extractor
  description: |
    Extract SAP-specific host details information.
  recency: "60s"
  dependencies:
    datasources:
      - name: placement-resource-provider-traits
      - name: nova-hypervisors
