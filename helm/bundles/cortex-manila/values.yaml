# Copyright 2025 SAP SE
# SPDX-License-Identifier: Apache-2.0

owner-info:
  enabled: true
  helm-chart-url: "https://github.com/cobaltcore-dev/cortex/helm/bundles/cortex-manila"
  maintainers:
    - "p.matthes@sap.com"
    - "markus.wieland@sap.com"
    - "arno.uhlig@sap.com"
  support-group: "workload-management"
  service: "cortex-manila"

alerts:
  enabled: true
  prometheus: openstack

# SSO certificate to use.
sharedSSOCert: &sharedSSOCert
  # Certificate "public key". (Optional, remove this key if not needed)
  cert: |
    -----BEGIN CERTIFICATE-----
    Your certificate here
    -----END CERTIFICATE-----
  # Certificate private key. (Optional, remove this key if not needed)
  key: |
    -----BEGIN PRIVATE KEY-----
    Your private key here
    -----END PRIVATE KEY
  # Whether the certificate is self-signed.
  # If true, the certificate is not verified.
  selfSigned: "false"

postgres:
  host: cortex-manila-postgresql
  user: postgres
  password: secret
  database: postgres
  port: "5432"

datasources:
  prometheus:
    url: "https://path-to-your-prometheus"
    sso:
      enabled: false
      <<: *sharedSSOCert
  openstack:
    url: "https://path-to-keystone/v3"
    availability: public
    username: openstack-user-with-all-project-read-access
    password: openstack-user-password
    projectName: openstack-project-of-user
    userDomainName: openstack-domain-of-user
    projectDomainName: openstack-domain-of-project-scoped-to
    sso:
      enabled: false
      <<: *sharedSSOCert

# Values accessible to all subcharts.
global:
  # Values passed to the service through a configmap.
  conf:
    # MQTT broker connection parameters.
    mqtt:
      # Must match rabbitmq settings from the cortex-mqtt chart.
      url: "tcp://cortex-manila-mqtt:1883"

    # Connection parameters for the database where data is stored.
    db:
      # Must match postgresql settings from the cortex-postgres chart.
      host: cortex-manila-postgresql

# Custom configuration for the cortex postgres chart.
cortex-postgres:
  fullnameOverride: cortex-manila-postgresql

# Custom configuration for the cortex mqtt chart.
cortex-mqtt:
  fullnameOverride: cortex-manila-mqtt

# Custom configuration for the cortex core chart.
cortex-alerts:
  fullnameOverride: cortex-manila
  alerts:
    componentPrefix: cortex-manila

cortex-kpis:
  fullnameOverride: cortex-manila-kpis
  service:
    extraLabels:
      app: cortex-manila-kpis # See below, used for the service monitor.
  serviceMonitor:
    matchLabels: # See above, this is used to select the postgresql service.
      app: cortex-manila-kpis
  args: []
  conf:
    kpis:
      # Configuration of KPIs that should be extracted from the synced data.
      #
      # The `name` should correspond to a known KPI extractor plugin.
      plugins:
        # NetApp-specific KPIs.
        - name: netapp_storage_pool_cpu_usage_kpi

cortex-knowledge-operator:
  # CRDs are deployed in the cortex-crds chart.
  crd: {enable: false}
  # Use this to unambiguate multiple cortex deployments in the same cluster.
  namePrefix: cortex-manila
  conf:
    # The operator will only touch CRs with this operator name.
    operator: cortex-manila

cortex-scheduling-operator:
  # CRDs are deployed in the cortex-crds chart.
  crd: {enable: false}
  # Use this to unambiguate multiple cortex deployments in the same cluster.
  namePrefix: cortex-manila
  conf:
    # The operator will only touch CRs with this operator name.
    operator: cortex-manila
    scheduler:
      manila:
        pipelines:
          # Note: there needs to be at least one pipeline with the name "default".
          - name: default
            # Configuration of scheduler steps that modify the Manila scheduler weights.
            #
            # The `name` should correspond to a known scheduler plugin.
            # Note that all scheduler steps will be executed in parallel. However,
            # the order will be maintained when the weights are applied to the
            # input weights.
            plugins:
              # Balance cpu utilization of Manila storage pools.
              - name: netapp_cpu_usage_balancing
                options:
                  # Min-max scaling for gap-fitting based on CPU usage (pct)
                  avgCPUUsageLowerBound: 0 # pct
                  avgCPUUsageUpperBound: 10 # pct
                  avgCPUUsageActivationLowerBound: 0.0
                  avgCPUUsageActivationUpperBound: -0.75
                  maxCPUUsageLowerBound: 0 # pct
                  maxCPUUsageUpperBound: 10 # pct
                  maxCPUUsageActivationLowerBound: 0.0
                  maxCPUUsageActivationUpperBound: -0.25

