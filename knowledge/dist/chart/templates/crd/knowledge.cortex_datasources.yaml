{{- if .Values.crd.enable }}
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  labels:
    {{- include "chart.labels" . | nindent 4 }}
  annotations:
    {{- if .Values.crd.keep }}
    "helm.sh/resource-policy": keep
    {{- end }}
    controller-gen.kubebuilder.io/version: v0.17.2
  name: datasources.knowledge.cortex
spec:
  group: knowledge.cortex
  names:
    kind: Datasource
    listKind: DatasourceList
    plural: datasources
    singular: datasource
  scope: Cluster
  versions:
  - additionalPrinterColumns:
    - jsonPath: .spec.type
      name: Type
      type: string
    - jsonPath: .spec.operator
      name: Operator
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Created
      type: date
    - jsonPath: .status.lastSynced
      name: Synced
      type: date
    - jsonPath: .status.lastSyncDurationMs
      name: Took [ms]
      type: integer
    - jsonPath: .status.nextSyncTime
      name: Next
      type: string
    - jsonPath: .status.numberOfObjects
      name: Objects
      type: integer
    - jsonPath: .status.error
      name: Error
      type: string
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Datasource is the Schema for the datasources API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of Datasource
            properties:
              databaseSecretRef:
                description: |-
                  Database credentials to use for the datasource.
                  The secret should contain the following keys:
                  - "username": The database username.
                  - "password": The database password.
                  - "host": The database host.
                  - "port": The database port.
                  - "database": The database name.
                properties:
                  name:
                    description: name is unique within a namespace to reference a
                      secret resource.
                    type: string
                  namespace:
                    description: namespace defines the space within which the secret
                      name must be unique.
                    type: string
                type: object
                x-kubernetes-map-type: atomic
              openstack:
                description: |-
                  If given, configures an OpenStack datasource to fetch.
                  Type must be set to "openstack" if this is used.
                properties:
                  cinder:
                    description: |-
                      Datasource for openstack cinder.
                      Only required if Type is "cinder".
                    properties:
                      type:
                        description: The type of resource to sync.
                        type: string
                    required:
                    - type
                    type: object
                  identity:
                    description: |-
                      Datasource for openstack identity.
                      Only required if Type is "identity".
                    properties:
                      type:
                        description: The type of resource to sync.
                        type: string
                    required:
                    - type
                    type: object
                  limes:
                    description: |-
                      Datasource for openstack limes.
                      Only required if Type is "limes".
                    properties:
                      type:
                        description: The type of resource to sync.
                        type: string
                    required:
                    - type
                    type: object
                  manila:
                    description: |-
                      Datasource for openstack manila.
                      Only required if Type is "manila".
                    properties:
                      type:
                        description: The type of resource to sync.
                        type: string
                    required:
                    - type
                    type: object
                  nova:
                    description: |-
                      Datasource for openstack nova.
                      Only required if Type is "nova".
                    properties:
                      deletedServersChangesSinceMinutes:
                        description: |-
                          Time frame in minutes for the changes-since parameter when fetching
                          deleted servers. Set if the Type is "deletedServers".
                        type: integer
                      type:
                        description: The type of resource to sync.
                        type: string
                    required:
                    - type
                    type: object
                  placement:
                    description: |-
                      Datasource for openstack placement.
                      Only required if Type is "placement".
                    properties:
                      type:
                        description: The type of resource to sync.
                        type: string
                    required:
                    - type
                    type: object
                  secretRef:
                    description: |-
                      Keystone credentials secret ref for authenticating with openstack.
                      The secret should contain the following keys:
                      - "availability": The service availability, e.g. "public", "internal", or "admin".
                      - "url": The keystone auth URL.
                      - "username": The keystone username.
                      - "password": The keystone password.
                      - "userDomainName": The keystone user domain name.
                      - "projectName": The keystone project name.
                      - "projectDomainName": The keystone project domain name.
                    properties:
                      name:
                        description: name is unique within a namespace to reference
                          a secret resource.
                        type: string
                      namespace:
                        description: namespace defines the space within which the
                          secret name must be unique.
                        type: string
                    type: object
                    x-kubernetes-map-type: atomic
                  syncIntervalSeconds:
                    default: 60
                    description: How often to sync the datasource in seconds.
                    format: int64
                    minimum: 1
                    type: integer
                  type:
                    description: The type of the OpenStack datasource.
                    type: string
                required:
                - secretRef
                - syncIntervalSeconds
                - type
                type: object
              operator:
                description: The operator by which this datasource should be synced.
                type: string
              prometheus:
                description: |-
                  If given, configures a Prometheus datasource to fetch.
                  Type must be set to "prometheus" if this is used.
                properties:
                  alias:
                    description: |-
                      Especially when a more complex query is used, we need an alias
                      under which the table will be stored in the database.
                      Additionally, this alias is used to reference the metric in the
                      feature extractors as dependency.
                    type: string
                  intervalSeconds:
                    default: 86400
                    description: The interval at which to query the data.
                    minimum: 1
                    type: integer
                  query:
                    description: The query to use to fetch the metric.
                    type: string
                  resolutionSeconds:
                    default: 43200
                    description: The resolution of the data in seconds.
                    minimum: 1
                    type: integer
                  secretRef:
                    description: |-
                      Secret containing the following keys:
                      - "url": The prometheus URL.
                    properties:
                      name:
                        description: name is unique within a namespace to reference
                          a secret resource.
                        type: string
                      namespace:
                        description: namespace defines the space within which the
                          secret name must be unique.
                        type: string
                    type: object
                    x-kubernetes-map-type: atomic
                  timeRangeSeconds:
                    default: 2419200
                    description: Time range in seconds to query the data for.
                    minimum: 1
                    type: integer
                  type:
                    description: |-
                      The type of the metric, mapping directly to a metric model supported
                      by cortex. Note that the metrics are fetched as time series, not instant.
                    type: string
                required:
                - alias
                - query
                - secretRef
                - type
                type: object
              ssoSecretRef:
                description: |-
                  Kubernetes secret ref for an optional sso certificate to access the host.
                  The secret should contain two keys: "cert" and "key".
                properties:
                  name:
                    description: name is unique within a namespace to reference a
                      secret resource.
                    type: string
                  namespace:
                    description: namespace defines the space within which the secret
                      name must be unique.
                    type: string
                type: object
                x-kubernetes-map-type: atomic
              type:
                description: The type of the datasource.
                type: string
            required:
            - databaseSecretRef
            - type
            type: object
          status:
            description: status defines the observed state of Datasource
            properties:
              error:
                description: If there was an error during the last sync, it is recorded
                  here.
                type: string
              lastSyncDurationMs:
                description: The time it took to perform the last sync.
                format: int64
                type: integer
              lastSynced:
                description: When the datasource was last successfully synced.
                format: date-time
                type: string
              nextSyncTime:
                description: Planned time for the next sync.
                format: date-time
                type: string
              numberOfObjects:
                description: The number of objects currently stored for this datasource.
                format: int64
                type: integer
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
{{- end -}}
